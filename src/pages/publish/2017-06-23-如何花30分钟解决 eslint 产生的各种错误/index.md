---
title: å¦‚ä½•èŠ±30åˆ†é’Ÿè§£å†³ eslint äº§ç”Ÿçš„å„ç§é”™è¯¯
tags:
  - js
categories:
  - æŠ€æœ¯
date: 2017-06-23T00:09:24.000Z
path: /how-to-lint-legacy-jscode-in-30min/
---

æœ¬æ–‡ä¸»è¦æ€»ç»“å¦‚ä½•ä½¿ç”¨ eslint , prettier, ä»¥åŠ jscodeshift å¿«é€Ÿç»Ÿä¸€ä¸€ä¸ªå¤§å‹çš„ js é¡¹ç›®çš„ä»£ç é£æ ¼,å¹¶ç»“åˆ lint-staged å’Œ husky è‡ªåŠ¨æ£€æŸ¥å¹¶ä¸”æ ¼å¼åŒ–æœªæ¥æ–°æäº¤çš„æ–°ä»£ç .

<!--more-->

## ç¡®è®¤ lint è§„åˆ™ , æ‰§è¡Œ lint

é¡¹ç›®æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ react+redux é¡¹ç›®,ç”¨ es6 ç¼–å†™,æ‰€ä»¥éœ€è¦ `babel-eslint` ä½œä¸ºè§£æå™¨ç›´æ¥è§£æ es6 ä»£ç .å› ä¸º react ä½¿ç”¨äº† jsx ä»£ç ,æ‰€ä»¥åŠ äº† `eslint-plugin-react` è¿™ä¸ªé¢å¤–çš„æ’ä»¶.

æ‰§è¡Œ:

    yarn add -D eslint eslint eslint-plugin-react babel-eslint

å®‰è£…æ‰€æœ‰ä¾èµ–.

`.eslintrc.js` é…ç½®å¦‚ä¸‹:

```js
module.exports = {
  extends: ["eslint:recommended"],
  parser: "babel-eslint",
  plugins: ["react"],
  env: {
    browser: true,
    node: true,
    es6: true,
    jest: true
  }
};
```

åŸºäº eslint å®˜æ–¹æ¨èçš„[è§„åˆ™](http://eslint.org/docs/rules/).

åœ¨ package.json çš„ script é‡Œé¢æ–°åŠ ä¸€æ¡ `lint:"eslint src --ext .jsx,.jsx"`, æ„æ€æ˜¯ lint é¡¹ç›® src ä¸‹é¢æ‰€æœ‰çš„ js å’Œ jsx æ–‡ä»¶.

æ ¹æ®é¡¹ç›®è§„æ¨¡ä¼šæŸ¥å‡ºå¥½å¤šæ½œåœ¨çš„ä»£ç é—®é¢˜,æ¯”å¦‚å¦‚ä¸‹è¿™ä¸ªé¡¹ç›®.

![](./2017-06-23-14980548895957.jpg "2017-06-23-14980548895957")

![](./2017-06-23-14980568706371.jpg "2017-06-23-14980568706371")

çœ‹åˆ° 4 åƒå¤šä¸ªé”™è¯¯,æˆ‘çš„å†…å¿ƒæ˜¯å¦‚ä¸Šå›¾æ‰€ç¤º ğŸ˜‚.

## ä¿®å¤æœ‰é—®é¢˜çš„ä»£ç 

æ‰«æäº†ä¸€ä¸‹é”™è¯¯,å¤§è‡´æœ‰ä»¥ä¸‹å‡ ç±»é”™è¯¯:

1.  `quotes`: å¿…é¡»ä½¿ç”¨å•å¼•å·,è€Œä¸æ˜¯åŒå¼•å·è¡¨ç¤ºå­—ç¬¦ä¸².
2.  `prefer-template`: ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²æ“ä½œå­—ç¬¦ä¸²æ‹¼æ¥.
3.  `key-spacing`: å…³é”®å­—ä¹‹é—´çš„ç©ºæ ¼æ ·å¼é—®é¢˜.
4.  `brace-style`: å¤§æ‹¬å·çš„æ ·å¼
5.  `indent`:ç¼©è¿› 2 ä¸¤ä¸ªç©ºæ ¼.
6.  `prefer-const`: ä½¿ç”¨ `const` å…³é”®å­—è¡¨ç¤ºæ‰€æœ‰ä¸ä¼šè¢«ä¿®æ”¹çš„å˜é‡.
7.  `no-var`: ä¸ä½¿ç”¨ `var` è¡¨ç¤ºå˜é‡,è€Œæ˜¯ä½¿ç”¨ `let`.
8.  `no-unused-vars`:ä¸å…è®¸å®šä¹‰äº†ä½†æ˜¯æœªä½¿ç”¨çš„å˜é‡.
9.  `eqeqeq`: ä½¿ç”¨å…¨ç­‰ `===` æ¯”è¾ƒ
10. `no-undef`: å˜é‡æœªå®šä¹‰

eslint æ£€æŸ¥å‡ºæ¥çš„é”™è¯¯å¤§è‡´åˆ†ä¸ºä¸¤ç§,ä¸€ç§æ˜¯ä»£ç é£æ ¼æ–¹é¢çš„,å‰äº”ä¸ªå°±æ˜¯è¿™ä¸ªç±»å‹,ç»Ÿä¸€å®ƒä»¬å¯ä»¥æé«˜ä»£ç çš„å¯è¯»æ€§.å¦ä¸€ç§æ˜¯ä»£ç è´¨é‡æ–¹é¢çš„,åäº”ç§å°±æ˜¯è¿™ç§ç±»å‹,é€šè¿‡æ”¹è¿›è¿™äº›é—®é¢˜èƒ½å¤Ÿé¿å…ä¸€äº›æ½œåœ¨çš„é”™è¯¯å¹¶æé«˜ä»£ç çš„å¯é åº¦.

é€šè¿‡ç»™ eslint cli åŠ  `--fix` å‚æ•°èƒ½è‡ªåŠ¨ä¿®å¤ä¸€äº›ç®€å•çš„é”™è¯¯.åœ¨æˆ‘è¿è¡Œä¹‹åå‘ç°é¡¹ç›®è¿˜å‰©ä¸‹ 3000 å¤šä¸ªé”™è¯¯.å‰©ä½™çš„å¤§éƒ¨åˆ†æ˜¯ä»£ç è´¨é‡æ–¹é¢çš„.ä½†æ˜¯ä»£ç é£æ ¼æ–¹é¢è¿˜æ˜¯é—ç•™äº†å°‘é‡é—®é¢˜.

è¿™ä¸ªæ—¶å€™éœ€è¦ `eslint --fix` æŒ‡ä»¤çš„åŠ å¼ºç‰ˆå·¥å…· [prettier](https://github.com/prettier/prettier) å‡ºç°äº†.

![](./2017-06-23-14981374294351.jpg "2017-06-23-14981374294351")

### ä½¿ç”¨ prettier å’Œ eslint ä¿®å¤æ‰€æœ‰æ ·å¼é”™è¯¯

prettier æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ä»£ç æ ¼å¼åŒ–å·¥å…·,å®ƒèƒ½è‡ªåŠ¨æ ¼å¼åŒ– es6, jsx, flow,typescript å’Œ css , less, scss.å®ƒä½¿ç”¨å†…ç½®çš„ä»£ç æ ·å¼è§„åˆ™,åŸºæœ¬ä¸Šæ˜¯ä¸ªå‚»ç“œå‹çš„å…¨èƒ½ä»£ç æ ¼å¼åŒ–åˆ©å™¨.

> æ³¨æ„:prettier ä¼šé‡å†™æ‰€æœ‰çš„ä»£ç ,åŸºæœ¬ä¸Šæ˜¯é‡å†™äº†æ•´ä¸ª js æˆ–è€… css æ–‡ä»¶,æ‰€ä»¥ä¼šäº§ç”Ÿå¤§é‡çš„ä»£ç å·®å¼‚. æ‰€ä»¥åŠ¡å¿…åœ¨ä¸€ä¸ªå•ç‹¬çš„å¼€å‘æ—¶é—´å†…ç»Ÿä¸€å»åš lint å’Œæ ¼å¼åŒ–çš„å·¥ä½œ,å¹¶ç¡®ä¿ä¹‹åçš„å¼€å‘æ˜¯ä¿®æ”¹åŸºäºæ ¼å¼åŒ–ä¹‹åçš„.ä»¥å… git åˆå¹¶äº§ç”Ÿå¤§é‡å†²çª.

åœ¨ä½¿ç”¨`yarn global add prettier`å…¨å±€å®‰è£…äº† prettier ä¹‹ååœ¨é¡¹ç›®ä¸‹é¢æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤:

    prettier --write --trailing-comma es5 --single-quote "src/**/*.{js,jsx,css}"

è¿™å¥è¯çš„æ„æ€æ˜¯æ ¼å¼åŒ– src ä¸‹é¢æ‰€æœ‰çš„ js,jsx å’Œ css æ–‡ä»¶.

1.  `--write`:è¡¨ç¤ºæ ¼å¼åŒ–åç›´æ¥ä¿®æ”¹æ–‡ä»¶
2.  `--trailing-comma es5`: è¡Œå°¾é€—å·è§„åˆ™, `es5`è¡¨ç¤ºå½“å¯¹è±¡,æ•°ç»„çš„æœ€åä¸€é¡¹åœ¨æ¢è¡Œçš„æ—¶å€™åŠ é€—å·,ç±»ä¼¼ eslint çš„ [comma-dangle](http://eslint.org/docs/rules/comma-dangle) è§„åˆ™.
3.  `--single-quote`:å¼ºåˆ¶ä½¿ç”¨å•å¼•å·è¡¨ç¤ºå­—ç¬¦ä¸².

ç»å†äº†ä»¥ä¸Šå‘½ä»¤çš„æŠ˜è…¾,åœ¨æ‰§è¡Œ lint å‘½ä»¤,é”™è¯¯é™åˆ°äº† 1900,å·®ä¸å¤šå°‘äº†ä¸€åŠ.

![](./2017-06-23-14981387861470.jpg "2017-06-23-14981387861470")

æ¥ä¸‹æ¥è¯¥`js-codemod`ç™»åœºäº†.

### ä½¿ç”¨ js-codemod è½¬æ¢ js ä»£ç 

[js-codemode](https://github.com/cpojer/js-codemod)æ˜¯ä¸€ä¸ªä»£ç è½¬æ¢å·¥å…·,åŸºäº fb çš„ [jscodeshift](https://github.com/facebook/jscodeshift)æ¡†æ¶.é¦–å…ˆä½¿ç”¨

    yarn add global jscodeshift

åœ¨é¡¹ç›®çš„åŒçº§ç›®å½•,æ‰§è¡Œå…¨å±€å®‰è£…è¿™ä¸ªæ¡†æ¶.ä¹‹åæ‰§è¡Œ

    git clone https://github.com/cpojer/js-codemod.git

è·å– `js-codemod`

å…³äº js-codemod æ¯æ¡è§„åˆ™çš„è¯¦ç»†ç”¨æ³•,å¯ä»¥å‚è€ƒ[Turbocharged JavaScript Refactoring with Codemods](https://medium.com/airbnb-engineering/turbocharged-javascript-refactoring-with-codemods-b0cae8b326b9).

æˆ‘çš„é¡¹ç›®åªä½¿ç”¨äº†å…¶ä¸­å‡ ä¸ªä¼šæŠ¥é”™çš„:

[no-var](https://github.com/cpojer/js-codemod#no-vars):å»æ‰ `var`.

    jscodeshift -t js-codemod/transforms/no-vars.js ./lint-demo/src

[template-literals](https://github.com/cpojer/js-codemod#template-literals):ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²ä»£æ›¿å­—ç¬¦ä¸²æ‹¼æ¥.

    jscodeshift -t js-codemod/transforms/template-literals.js ./lint-demo/src

ç»å†äº†ä¸Šè¿°æŒ‡ä»¤,lint ç»“æœåˆå°‘äº†ä¸€ç‚¹:

![](./2017-06-23-14981427500861.jpg "2017-06-23-14981427500861")

js-codemod çš„ `no-vars`æŒ‡ä»¤è¿˜æœ‰ä¸€ç‚¹ç¼ºé™·,æ²¡æ³•å¸®æˆ‘ä»¬æŠŠ let è½¬æˆ const, æ‰€ä»¥ eslint è¿˜æ˜¯ä¼šæŠ¥ `prefer-const`çš„é”™è¯¯.

å‰©ä½™çš„é”™è¯¯ç§ç±»å…¶å®å¾ˆå°‘:

1.  prefer-const:ä½¿ç”¨ const å£°æ˜ä¸å˜é‡.
2.  no-undef:ä¸èƒ½ä½¿ç”¨æœªå®šä¹‰çš„å˜é‡
3.  radix:ä½¿ç”¨ parseInt å¼ºåˆ¶æŒ‡å®šè¿›åˆ¶.
4.  no-unused-vars:å»æ‰å®šä¹‰/æˆ–è€… import äº†ä½†æ˜¯æœªä½¿ç”¨çš„å˜é‡.

è¿™å››ç§ç›®å‰ä¸ºæ­¢æ²¡æœ‰å·¥å…·å¸®æˆ‘ä»¬è½¬æ¢,å¿…é¡»æ‰‹åŠ¨æ”¹.æˆ‘ä»¬çš„ç­–ç•¥æ˜¯å›¢é˜Ÿæˆå‘˜æ¯ä¸ªäººè®¤é¢†å‡ ä¸ªæ–‡ä»¶å¤¹,å„è‡ªä¿®æ”¹è¿™äº›é”™è¯¯.å› ä¸ºæˆ‘ä¸ªäººä½¿ç”¨ webstorm,ä¸‹é¢è¯´ä¸€äº› webstorm ä¸‹é¢å¦‚ä½•å¿«é€ŸæŸ¥çœ‹ eslint çš„é”™è¯¯å¹¶ä¸”ä¿®æ”¹.

é¦–å…ˆå¯ç”¨ webstorm çš„ eslint æ”¯æŒ:[ESLint in Webstrom](https://www.jetbrains.com/help/webstorm/2017.1/eslint.html).ä¹‹å IDE å°±èƒ½è‡ªåŠ¨è¯»å–é¡¹ç›®çš„ eslint é…ç½®å¹¶ä¸”åœ¨é”™è¯¯çš„ä»£ç å³è¾¹è‡ªåŠ¨æ ‡çº¢.æˆ‘ä»¬ç‚¹å‡»å°±èƒ½å¿«é€Ÿä¿®æ”¹.

æ”¾æ®µæ“ä½œå‹å‹æƒŠ.

![2017-06-22 23_36_58]\(<http://7xqh45.com1.z0.glb.clouddn.com/2017-06-23-2017-06-22> 23_36_58.gif)

> åœ¨åº”ç”¨`no-unused-vars`çš„æ—¶å€™è¦æ ¼å¤–å°å¿ƒ,ä¸è¦åˆ é”™ä¸œè¥¿.

ä»¥ä¸‹å°±æ˜¯è¡€çš„æ•™è®­.
æ¯”å¦‚

```js
const foobar = (a, b) => b;
foobar(null, 3);
```

è¿™æ®µä»£ç  foobar å‡½æ•°çš„å®ç°é‡Œé¢æ²¡æœ‰ç”¨åˆ° a, å¦‚æœæˆ‘ä»¬é²è½çš„åˆ æ‰äº† a è¿™ä¸ªå½¢å‚è€Œä¸æ”¹å˜è°ƒç”¨ foorbar æ˜¯ä¼ ç»™å®ƒçš„å®å‚çš„æ•°é‡,å°±ä¼šå¯¼è‡´ b å˜æˆ null. ç„¶åè¿™ç§è›‹ç–¼çš„ bug è¦æŸ¥åŠå¤©~.

## ä½¿ç”¨ husky ç»“åˆ lint-staged ä¿è¯æœªæ¥ä»£ç è´¨é‡

ç»å†äº†ä¸Šè¿°ä¸€ç•ªæŠ˜è…¾,ç»ˆäºæˆ‘ä»¬é¡¹ç›®é‡Œé¢çš„ä»£ç ç¬¦åˆ iso9001 å›½é™…è´¨é‡ä½“ç³»è®¤è¯äº† ğŸ¤£ğŸ¤£.

ä½†æ˜¯é—®é¢˜æ˜¯å¦‚ä½•ç¡®ä¿ä»¥åçš„ä¿®æ”¹ä¹Ÿéƒ½ç¬¦åˆæ ‡å‡†å‘¢? è¿™ä¸ªæ—¶å€™ä½ éœ€è¦ä¸€åªå“ˆå£«å¥‡~

![](./2017-06-23-14981464730361.jpg "2017-06-23-14981464730361")

[husky](https://github.com/typicode/husky):å“ˆå£«å¥‡æŠŠ [git é’©å­](https://github.com/typicode/husky/blob/master/HOOKS.md)çš„åŠŸèƒ½åŠ åˆ°äº† package çš„ script é‡Œé¢äº†.ä½¿æˆ‘ä»¬æœ‰èƒ½åŠ›ç›´æ¥è°ƒç”¨å…¶ä»–å‘½ä»¤è€Œä¸ç”¨æŠŠé’©å­è„šæœ¬å†™åœ¨é¡¹ç›®çš„ `.git/hook` é‡Œé¢, æ–¹ä¾¿å›¢é˜Ÿé—´ git é’©å­å‘½ä»¤çš„å…±äº«.

[lint-staged](https://github.com/okonet/lint-staged):è¿™ä¸ªåº“æ£€æŸ¥æ‰€æœ‰è¢« `git add` åŠ å…¥çš„æ–‡ä»¶,å¯¹è¿™äº›æ–‡ä»¶æ‰§è¡Œä½ éœ€è¦çš„æŸäº›å‘½ä»¤,åœ¨è¿™é‡Œ,æˆ‘ä»¬å¯ä»¥æ‰§è¡Œ eslint å’Œæ ¼å¼åŒ–ç›¸å…³çš„æ“ä½œ.

å…·ä½“è„šæœ¬ github å†™çš„å¾ˆæ¸…æ¥šäº†:

    {
      "scripts": {
        "precommit": "lint-staged"
      },
      "lint-staged": {
        "*.js": ["eslint --fix", "git add"]
      }
    }

è„šæœ¬ä¸‹é¢æ–°å¢ä¸€ä¸ªå‘½ä»¤ precommit(è¿™ä¸ªåå­—æ˜¯ git é’©å­åå­—,æ‰€ä»¥å¿…é¡»è¿™ä¹ˆå†™),å†æ–°å¢ä¸€ä¸ª`lint-staged`é…ç½®é¡¹(è¿™ä¸ªåå­—ä¹Ÿæ˜¯å†™æ­»çš„,å› ä¸º lint-staged åº“ä¾èµ–è¿™ä¸ªåå­—).ä½†æ˜¯è¿™ä¸ªé…ç½®é¡¹é‡Œé¢çš„å†…å®¹æ˜¯æ´»çš„.

ä¸Šè¿°å‘½ä»¤:

       "*.js": ["eslint --fix", "git add"]

çš„æ„æ€æ˜¯å¯¹æ‰€æœ‰çš„ js æ–‡ä»¶åšæ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤,ç„¶åæŠŠä¿®å¤åçš„æ–‡ä»¶åŠ å…¥ git.

æœ€åæŒ‰ç…§å®é™…éœ€æ±‚æˆ‘æŠŠå‘½ä»¤æ”¹æˆäº†å¦‚ä¸‹å½¢å¼ä¾›ä½ ä»¬å‚è€ƒ:

    "{src,dev}/**/*.{js,jsx}": [
      "eslint --fix",
      "prettier --write --trailing-comma es5 --single-quote",
      "git add"
    ]

é’ˆå¯¹ src å’Œ dev ä¸‹é¢æ‰€æœ‰çš„ js å’Œ jsx æ–‡ä»¶.

1.  é¦–å…ˆ eslint å¹¶ä¸”å°è¯•è‡ªåŠ¨ä¿®å¤æ‰€æœ‰é—®é¢˜.
2.  å†ç”¨ prettier æ ¼å¼åŒ–æ‰€æœ‰è¢«æ·»åŠ çš„ä»£ç .
3.  å†æŠŠç²¾ç¾çš„æ ¼å¼åŒ–åçš„ä»£ç åŠ å…¥ç‰ˆæœ¬åº“.
4.  å†™ commit,push, å®Œç¾æ”¶å·¥.
